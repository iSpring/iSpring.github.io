var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define("world/Utils",["require","exports"],function(e,t){"use strict";var r={GREATER:"GREATER",GEQUAL:"GEQUAL",LESS:"LESS",LEQUAL:"LEQUAL",isBool:function(e){return"boolean"==typeof e},isNumber:function(e){return"number"==typeof e},isInteger:function(e){var t=!1,r=this.isNumber(e);if(r){var i=parseFloat(e),n=parseInt(e);t=i==n}else t=!1;return t},judgeNumberBoundary:function(e,t,r){if(t!=this.GREATER&&t!=this.GEQUAL&&t!=this.LESS&&t!=this.LEQUAL)throw"operator is invalid";var i;return t==this.GREATER?i=e>r:t==this.GEQUAL?i=e>=r:t==this.LESS?i=e<r:t==this.LEQUAL&&(i=e<=r),i},isPositive:function(e){return this.judgeNumberBoundary(e,this.GREATER,0)},isNegative:function(e){return this.judgeNumberBoundary(e,this.LESS,0)},isNonNegative:function(e){return this.judgeNumberBoundary(e,this.GEQUAL,0)},isNonPositive:function(e){return this.judgeNumberBoundary(e,this.LEQUAL,0)},isPositiveInteger:function(e){return this.isPositive(e)&&this.isInteger(e)},isNonNegativeInteger:function(e){return this.isNonNegative(e)&&this.isInteger},isString:function(e){return"string"==typeof e},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},isFunction:function(e){return"function"==typeof e},isNull:function(e){return null===e},isUndefined:function(e){return"undefined"==typeof e},isNullOrUndefined:function(e){return this.isNull(e)||this.isUndefined(e)},isJsonObject:function(e){return"object"==typeof e&&!this.isNull(e)&&!this.isArray(e)},isDom:function(e){return e instanceof HTMLElement},forEach:function(e,t){if(this.isFunction(Array.prototype.forEach))e.forEach(t);else for(var r=0;r<e.length;r++)t(e[r],r,e)},filter:function(e,t){var r=[];if(this.isFunction(Array.prototype.filter))r=e.filter(t);else for(var i=0;i<e.length;i++)t(e[i],i,e)&&r.push(e[i]);return r},map:function(e,t){var r=[];if(this.isFunction(Array.prototype.map))r=e.map(t);else for(var i=0;i<e.length;i++)r.push(t(e[i],i,e));return r},some:function(e,t){if(this.isFunction(Array.prototype.some))return e.some(t);for(var r=0;r<e.length;r++)if(t(e[r],r,e))return!0;return!1},every:function(e,t){if(this.isFunction(Array.prototype.every))return e.every(t);for(var r=0;r<e.length;r++)if(!t(e[r],r,e))return!1;return!0},filterRepeatArray:function(e){for(var t=this.map(e,function(e){return e}),r=[];t.length>0;){var i=t[0],n=this.some(r,function(e){return i.equals(e)});n||r.push(i),t.splice(0,1)}return r}};return r}),define("world/ShaderContent",["require","exports"],function(e,t){"use strict";var r="\nattribute vec3 aVertexPosition;\nattribute vec2 aTextureCoord;  \nvarying vec2 vTextureCoord;\n\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\n\nvoid main()\n{\n    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);\n    vTextureCoord = aTextureCoord;\n}\n",i="\n#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform bool uUseTexture;\nuniform float uShininess;\nuniform vec3 uLightDirection;\n\nuniform vec4 uLightAmbient;\nuniform vec4 uLightDiffuse;\nuniform vec4 uLightSpecular;\n\nvarying vec2 vTextureCoord;  \nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}\n";return{SIMPLE_SHADER:{VS_CONTENT:r,FS_CONTENT:i}}}),define("world/Vertice",["require","exports"],function(e,t){"use strict";var r=function(){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),this.x=e,this.y=t,this.z=r}return e.prototype.getArray=function(){return[this.x,this.y,this.z]},e.prototype.clone=function(){return new e(this.x,this.y,this.z)},e.prototype.getOpposite=function(){return new e((-this.x),(-this.y),(-this.z))},e}();return r}),define("world/Vector",["require","exports","world/Vertice"],function(e,t,r){"use strict";var i=function(){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),this.x=e,this.y=t,this.z=r}return e.fromVertice=function(t){return new e(t.x,t.y,t.z)},e.verticeMinusVertice=function(t,r){return new e(t.x-r.x,t.y-r.y,t.z-r.z)},e.verticePlusVector=function(e,t){return new r(e.x+t.x,e.y+t.y,e.z+t.z)},e.prototype.getVertice=function(){return new r(this.x,this.y,this.z)},e.prototype.getArray=function(){return[this.x,this.y,this.z]},e.prototype.clone=function(){return new e(this.x,this.y,this.z)},e.prototype.getOpposite=function(){return new e((-this.x),(-this.y),(-this.z))},e.prototype.getLength=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},e.prototype.normalize=function(){var e=this.getLength();return Math.abs(e)>=1e-6?(this.x/=e,this.y/=e,this.z/=e):(this.x=0,this.y=0,this.z=0),this},e.prototype.setLength=function(e){return this.normalize(),this.x*=e,this.y*=e,this.z*=e,this},e.prototype.getRandomVerticalVector=function(){var t,r=this.getLength();if(0===r)t=new e(0,0,0);else{var i,n,o;0!==this.x?(n=1,o=0,i=-this.y/this.x):0!==this.y?(o=1,i=0,n=-this.z/this.y):0!==this.z&&(i=1,n=0,o=-this.x/this.z),t=new e(i,n,o),t.normalize()}return t},e.prototype.cross=function(t){var r=this.y*t.z-this.z*t.y,i=this.z*t.x-this.x*t.z,n=this.x*t.y-this.y*t.x;return new e(r,i,n)},e.prototype.dot=function(t){if(!(t instanceof e))throw"invalid other";return this.x*t.x+this.y*t.y+this.z*t.z},e}();return i}),define("world/Line",["require","exports"],function(e,t){"use strict";var r=function(){function e(e,t){this.vertice=e.clone(),this.vector=t.clone(),this.vector.normalize()}return e.prototype.setVertice=function(e){return this.vertice=e.clone(),this},e.prototype.setVector=function(e){return this.vector=e.clone(),this.vector.normalize(),this},e.prototype.clone=function(){var t=new e(this.vertice,this.vector);return t},e}();return r}),define("world/Plan",["require","exports"],function(e,t){"use strict";var r=function(){function e(e,t,r,i){this.A=e,this.B=t,this.C=r,this.D=i}return e.prototype.clone=function(){var t=new e(this.A,this.B,this.C,this.D);return t},e}();return r}),define("world/Math",["require","exports","world/Kernel","world/Utils","world/Vertice","world/Vector","world/Line","world/Plan"],function(e,t,r,i,n,o,a,s){"use strict";var l={ONE_RADIAN_EQUAL_DEGREE:57.29577951308232,ONE_DEGREE_EQUAL_RADIAN:.017453292519943295,LEFT_TOP:"LEFT_TOP",RIGHT_TOP:"RIGHT_TOP",LEFT_BOTTOM:"LEFT_BOTTOM",RIGHT_BOTTOM:"RIGHT_BOTTOM",LEFT:"LEFT",RIGHT:"RIGHT",TOP:"TOP",BOTTOM:"BOTTOM",izZero:function(e){if(!i.isNumber(e))throw"invalid value";return Math.abs(e)<1e-6},numerationSystemTo10:function(e,t){for(var r=0,i=0;i<t.length;i++){var n=t.length-1-i,o=parseInt(t[i]);r+=o*Math.pow(e,n)}return r},numerationSystemFrom10:function(e,t){var r=[],i=Math.floor(t/e),n=t%e;for(r.push(n);0!=i;)t=i,i=Math.floor(t/e),n=t%e,r.push(n);r.reverse();var o=r.join("");return o},numerationSystemChange:function(e,t,r){var i=this.numerationSystemTo10(e,r),n=this.numerationSystemFrom10(t,i);return n},getTriangleArea:function(e,t,r){var i=e.clone(),n=t.clone(),s=r.clone(),l=o.verticeMinusVertice(s,n),h=new a(n,l),u=this.getLengthFromVerticeToLine(i,h),c=this.getLengthFromVerticeToVertice(n,s),v=.5*c*u;return v},getLengthFromVerticeToVertice:function(e,t){var r=e.clone(),i=t.clone(),n=Math.pow(r.x-i.x,2)+Math.pow(r.y-i.y,2)+Math.pow(r.z-i.z,2),o=Math.sqrt(n);return o},getLengthFromVerticeToLine:function(e,t){var r=e.clone(),i=t.clone(),n=r.x,o=r.y,a=r.z,s=i.vertice,l=s.x,h=s.y,u=s.z,c=i.vector;c.normalize();var v=c.x,f=c.y,d=c.z,p=(o-h)*d-f*(a-u),g=(a-u)*v-d*(n-l),m=(n-l)*f-v*(o-h);return Math.sqrt(p*p+g*g+m*m)},getLengthFromVerticeToPlan:function(e,t){var r=e.clone(),i=t.clone(),n=r.x,o=r.y,a=r.z,s=i.A,l=i.B,h=i.C,u=i.D,c=Math.abs(s*n+l*o+h*a+u),v=Math.sqrt(s*s+l*l+h*h),f=c/v;return f},getVerticeVerticalIntersectPointWidthPlan:function(e,t){var r=e.clone(),i=t.clone(),a=r.x,s=r.y,l=r.z,h=new o(i.A,i.B,i.C);h.normalize();var u=h.x,c=h.y,v=h.z,f=i.D*u/i.A,d=-(u*a+c*s+v*l+f),p=d*u+a,g=d*c+s,m=d*v+l,T=new n(p,g,m);return T},getIntersectPointByLineAdPlan:function(e,t){var r=e.clone(),i=t.clone();r.vector.normalize();var o=i.A,a=i.B,s=i.C,l=i.D,h=r.vertice.x,u=r.vertice.y,c=r.vertice.z,v=r.vector.x,f=r.vector.y,d=r.vector.z,p=-(o*h+a*u+s*c+l)/(o*v+a*f+s*d),g=p*v+h,m=p*f+u,T=p*d+c,y=new n(g,m,T);return y},getLineIntersectPointWithEarth:function(e){var t=[],i=e.clone(),o=i.vertice,a=i.vector;a.normalize();var s=r.EARTH_RADIUS,l=a.x,h=a.y,u=a.z,c=o.x,v=o.y,f=o.z,d=l*l,p=h*h,g=u*u,m=s*s,T=l*v,y=l*f,w=h*c,E=h*f,L=u*c,x=u*v,M=T*w+y*L+E*x,R=T*T+y*y+w*w+E*E+L*L+x*x,C=d+p+g,_=8*M-4*R+4*m*C;if(_<0)t=[];else{var b=l*c+h*v+u*f,I=d+p+g;if(0==_){var A=-b/I,P=A*l+c,B=A*h+v,V=A*u+f,D=new n(P,B,V);t.push(D)}else if(_>0){var N=Math.sqrt(_),O=(-2*b+N)/(2*I),S=O*l+c,G=O*h+v,F=O*u+f,U=new n(S,G,F);t.push(U);var z=(-2*b-N)/(2*I),X=z*l+c,W=z*h+v,Y=z*u+f,j=new n(X,W,Y);t.push(j)}}return t},getCrossPlaneByLine:function(e,t){var r=e.clone(),i=t.clone();i.normalize();var n=i.x,o=i.y,a=i.z,l=r.x,h=r.y,u=r.z,c=-(n*l+o*h+a*u),v=new s(n,o,a,c);return v},convertPointFromCanvasToNDC:function(e,t){if(!i.isNumber(e))throw"invalid canvasX";if(!i.isNumber(t))throw"invalid canvasY";var n=2*e/r.canvas.width-1,o=1-2*t/r.canvas.height;return[n,o]},convertPointFromNdcToCanvas:function(e,t){if(!i.isNumber(e))throw"invalid ndcX";if(!i.isNumber(t))throw"invalid ndcY";var n=(1+e)*r.canvas.width/2,o=(1-t)*r.canvas.height/2;return[n,o]},getLengthFromCamera2EarthSurface:function(e){return 7820683/Math.pow(2,e)},geographicToCartesianCoord:function(e,t,i){if(void 0===i&&(i=r.EARTH_RADIUS),!(e>=-180.001&&e<=180.001))throw"invalid lon";if(!(t>=-90.001&&t<=90.001))throw"invalid lat";var o=this.degreeToRadian(e),a=this.degreeToRadian(t),s=Math.sin(o),l=Math.cos(o),h=Math.sin(a),u=Math.cos(a),c=i*s*u,v=i*h,f=i*l*u;return new n(c,v,f)},cartesianCoordToGeographic:function(e){var t=e.clone(),i=t.x,n=t.y,o=t.z,a=n/r.EARTH_RADIUS;a>1?a=2:a<-1&&(a=-1);var s=Math.asin(a),l=Math.cos(s),h=i/(r.EARTH_RADIUS*l);h>1?h=1:h<-1&&(h=-1);var u=o/(r.EARTH_RADIUS*l);u>1?u=1:u<-1&&(u=-1);var c=Math.asin(h);c=h>=0?u>=0?c:Math.PI-c:u>=0?c:-c-Math.PI;var v=this.radianToDegree(s),f=this.radianToDegree(c);return[f,v]},degreeToRadian:function(e){return e*this.ONE_DEGREE_EQUAL_RADIAN},radianToDegree:function(e){return e*this.ONE_RADIAN_EQUAL_DEGREE},webMercatorXToRadianLog:function(e){return e/r.EARTH_RADIUS},webMercatorXToDegreeLog:function(e){var t=this.webMercatorXToRadianLog(e);return this.radianToDegree(t)},webMercatorYToRadianLat:function(e){if(!i.isNumber(e))throw"invalid y";var t=e/r.EARTH_RADIUS,n=Math.pow(Math.E,t),o=Math.atan(n),a=2*o-Math.PI/2;return a},webMercatorYToDegreeLat:function(e){var t=this.webMercatorYToRadianLat(e);return this.radianToDegree(t)},webMercatorToRadianGeographic:function(e,t){var r=this.webMercatorXToRadianLog(e),i=this.webMercatorYToRadianLat(t);return[r,i]},webMercatorToDegreeGeographic:function(e,t){var r=this.webMercatorXToDegreeLog(e),i=this.webMercatorYToDegreeLat(t);return[r,i]},radianLogToWebMercatorX:function(e){if(!(i.isNumber(e)&&e<=Math.PI+.001&&e>=-(Math.PI+.001)))throw"invalid radianLog";return r.EARTH_RADIUS*e},degreeLogToWebMercatorX:function(e){if(!(i.isNumber(e)&&e<=180.001&&e>=-180.001))throw"invalid degreeLog";var t=this.degreeToRadian(e);return this.radianLogToWebMercatorX(t)},radianLatToWebMercatorY:function(e){if(!(e<=Math.PI/2+.001&&e>=-(Math.PI/2+.001)))throw"invalid radianLat";var t=Math.PI/4+e/2,i=Math.tan(t),n=Math.log(i),o=r.EARTH_RADIUS*n;return o},degreeLatToWebMercatorY:function(e){if(!(e<=90.001&&e>=-90.001))throw"invalid degreeLat";var t=this.degreeToRadian(e);return this.radianLatToWebMercatorY(t)},radianGeographicToWebMercator:function(e,t){var r=this.radianLogToWebMercatorX(e),i=this.radianLatToWebMercatorY(t);return[r,i]},degreeGeographicToWebMercator:function(e,t){var r=this.degreeLogToWebMercatorX(e),i=this.degreeLatToWebMercatorY(t);return[r,i]},getTileWebMercatorEnvelopeByGrid:function(e,t,i){var n=r.MAX_PROJECTED_COORD,o=2*n/Math.pow(2,e),a=-n+i*o,s=a+o,l=n-t*o,h=l-o,u={minX:a,minY:h,maxX:s,maxY:l};return u},getTileGeographicEnvelopByGrid:function(e,t,r){var i=this.getTileWebMercatorEnvelopeByGrid(e,t,r),n=this.webMercatorToDegreeGeographic(i.minX,i.minY),o=this.webMercatorToDegreeGeographic(i.maxX,i.maxY),a={minLon:n[0],minLat:n[1],maxLon:o[0],maxLat:o[1]};return a},getTileCartesianEnvelopByGrid:function(e,t,r){var i=this.getTileGeographicEnvelopByGrid(e,t,r),n=i.minLon,o=i.minLat,a=i.maxLon,s=i.maxLat,l=this.geographicToCartesianCoord(n,o),h=this.geographicToCartesianCoord(n,s),u=this.geographicToCartesianCoord(a,s),c=this.geographicToCartesianCoord(a,o),v={pLeftBottom:l,pLeftTop:h,pRightTop:u,pRightBottom:c,minLon:n,minLat:o,maxLon:a,maxLat:s};return v},getGeographicTileCenter:function(e,t,r){var i=this.getTileGeographicEnvelopByGrid(e,t,r),n=i.minLon,o=i.minLat,a=i.maxLon,s=i.maxLat,l=(n+a)/2,h=(o+s)/2,u=[l,h];return u},getCartesianTileCenter:function(e,t,r){var i=this.getGeographicTileCenter(e,t,r),n=this.geographicToCartesianCoord(i[0],i[1]);return n},calculateNormals:function(e,t){for(var r=0,i=1,n=2,o=[],a=0;a<e.length;a+=3)o[a+r]=0,o[a+i]=0,o[a+n]=0;for(var a=0;a<t.length;a+=3){var s=[],l=[],h=[];s[r]=e[3*t[a+2]+r]-e[3*t[a+1]+r],s[i]=e[3*t[a+2]+i]-e[3*t[a+1]+i],s[n]=e[3*t[a+2]+n]-e[3*t[a+1]+n],l[r]=e[3*t[a]+r]-e[3*t[a+1]+r],l[i]=e[3*t[a]+i]-e[3*t[a+1]+i],l[n]=e[3*t[a]+n]-e[3*t[a+1]+n],h[r]=s[i]*l[n]-s[n]*l[i],h[i]=s[n]*l[r]-s[r]*l[n],h[n]=s[r]*l[i]-s[i]*l[r];for(var u=0;u<3;u++)o[3*t[a+u]+r]=o[3*t[a+u]+r]+h[r],o[3*t[a+u]+i]=o[3*t[a+u]+i]+h[i],o[3*t[a+u]+n]=o[3*t[a+u]+n]+h[n]}for(var a=0;a<e.length;a+=3){var c=[];c[r]=o[a+r],c[i]=o[a+i],c[n]=o[a+n];var v=Math.sqrt(c[r]*c[r]+c[i]*c[i]+c[n]*c[n]);0==v&&(v=1),c[r]=c[r]/v,c[i]=c[i]/v,c[n]=c[n]/v,o[a+r]=c[r],o[a+i]=c[i],o[a+n]=c[n]}return o}};return l}),define("world/TileGrid",["require","exports","world/Kernel","world/Math"],function(e,t,r,i){"use strict";var n=function(){function e(e,t,r){this.level=e,this.row=t,this.column=r}return e.prototype.equals=function(e){return e&&this.level===e.level&&this.row===e.row&&this.column===e.column},e.prototype.getLeft=function(){return e.getTileGridByBrother(this.level,this.row,this.column,i.LEFT)},e.prototype.getRight=function(){return e.getTileGridByBrother(this.level,this.row,this.column,i.RIGHT)},e.prototype.getTop=function(){return e.getTileGridByBrother(this.level,this.row,this.column,i.TOP)},e.prototype.getBottom=function(){return e.getTileGridByBrother(this.level,this.row,this.column,i.BOTTOM)},e.prototype.getParent=function(){return e.getTileGridAncestor(this.level-1,this.level,this.row,this.column)},e.prototype.getAncestor=function(t){return e.getTileGridAncestor(t,this.level,this.row,this.column)},e.getTileGridByParent=function(t,r,i,n){var o=t+1,a=-1,s=-1;if(n==e.LEFT_TOP)a=2*r,s=2*i;else if(n==e.RIGHT_TOP)a=2*r,s=2*i+1;else if(n==e.LEFT_BOTTOM)a=2*r+1,s=2*i;else{if(n!=e.RIGHT_BOTTOM)throw"invalid position";a=2*r+1,s=2*i+1}return new e(o,a,s)},e.getTilePositionOfParent=function(e,t,r,i){var n="UNKNOWN";i=i||this.getTileGridAncestor(e-1,e,t,r);var o=this.getTileGridByParent(i.level,i.row,i.column,this.LEFT_TOP);return o.row==t?o.column==r?n=this.LEFT_TOP:o.column+1==r&&(n=this.RIGHT_TOP):o.row+1==t&&(o.column==r?n=this.LEFT_BOTTOM:o.column+1==r&&(n=this.RIGHT_BOTTOM)),n},e.getTileGridByBrother=function(t,r,i,n,o){o=o||{};var a=new e(t,r,i);if(n===e.LEFT)if(0==i){var s=o.maxSize||Math.pow(2,t);a.column=s-1}else a.column=i-1;else if(n==e.RIGHT){var s=o.maxSize||Math.pow(2,t);i==s-1?a.column=0:a.column=i+1}else if(n==e.TOP)if(0==r){var s=o.maxSize||Math.pow(2,t);a.row=s-1}else a.row=r-1;else{if(n!=e.BOTTOM)throw"invalid position";var s=o.maxSize||Math.pow(2,t);r==s-1?a.row=0:a.row=r+1}return a},e.getTileGridAncestor=function(t,r,i,n){var o=null;if(t<r){var a=r-t,s=Math.pow(2,a),l=Math.floor(i/s),h=Math.floor(n/s);o=new e(t,l,h)}else t==r&&(o=new e(r,i,n));return o},e.getTileGridByGeo=function(t,n,o){if(!(t>=-180&&t<=180))throw"invalid lon";if(!(n>=-90&&n<=90))throw"invalid lat";var a=i.degreeGeographicToWebMercator(t,n),s=a[0],l=a[1],h=s+r.MAX_PROJECTED_COORD,u=r.MAX_PROJECTED_COORD-l,c=r.MAX_PROJECTED_COORD/Math.pow(2,o-1),v=Math.floor(u/c),f=Math.floor(h/c);return new e(o,v,f)},e.LEFT_TOP="LEFT_TOP",e.RIGHT_TOP="RIGHT_TOP",e.LEFT_BOTTOM="LEFT_BOTTOM",e.RIGHT_BOTTOM="RIGHT_BOTTOM",e.LEFT="LEFT",e.RIGHT="RIGHT",e.TOP="TOP",e.BOTTOM="BOTTOM",e}();return n}),define("world/Matrix",["require","exports","world/Vertice","world/Vector"],function(e,t,r,i){"use strict";var n=function(){function e(e,t,r,i,n,o,a,s,l,h,u,c,v,f,d,p){void 0===e&&(e=1),void 0===t&&(t=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===l&&(l=0),void 0===h&&(h=0),void 0===u&&(u=1),void 0===c&&(c=0),void 0===v&&(v=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=1),this.elements=new Float32Array(16),this.setElements(e,t,r,i,n,o,a,s,l,h,u,c,v,f,d,p)}return e.prototype.setElements=function(e,t,r,i,n,o,a,s,l,h,u,c,v,f,d,p){var g=arguments.length;if(g<16)throw"invalid arguments:arguments length error";var m=this.elements;return m[0]=e,m[4]=t,m[8]=r,m[12]=i,m[1]=n,m[5]=o,m[9]=a,m[13]=s,m[2]=l,m[6]=h,m[10]=u,m[14]=c,m[3]=v,m[7]=f,m[11]=d,m[15]=p,this},e.prototype.setColumnX=function(e,t,r){this.elements[0]=e,this.elements[1]=t,this.elements[2]=r},e.prototype.getColumnX=function(){return new i(this.elements[0],this.elements[1],this.elements[2])},e.prototype.setColumnY=function(e,t,r){this.elements[4]=e,this.elements[5]=t,this.elements[6]=r},e.prototype.getColumnY=function(){return new i(this.elements[4],this.elements[5],this.elements[6])},e.prototype.setColumnZ=function(e,t,r){this.elements[8]=e,this.elements[9]=t,this.elements[10]=r},e.prototype.getColumnZ=function(){return new i(this.elements[8],this.elements[9],this.elements[10])},e.prototype.setColumnTrans=function(e,t,r){this.elements[12]=e,this.elements[13]=t,this.elements[14]=r},e.prototype.getColumnTrans=function(){return new r(this.elements[12],this.elements[13],this.elements[14])},e.prototype.setLastRowDefault=function(){this.elements[3]=0,this.elements[7]=0,this.elements[11]=0,this.elements[15]=1},e.prototype.transpose=function(){var e=this.getTransposeMatrix();this.setMatrixByOther(e)},e.prototype.getTransposeMatrix=function(){var t=new e;return t.elements[0]=this.elements[0],t.elements[4]=this.elements[1],t.elements[8]=this.elements[2],t.elements[12]=this.elements[3],t.elements[1]=this.elements[4],t.elements[5]=this.elements[5],t.elements[9]=this.elements[6],t.elements[13]=this.elements[7],t.elements[2]=this.elements[8],t.elements[6]=this.elements[9],t.elements[10]=this.elements[10],t.elements[14]=this.elements[11],t.elements[3]=this.elements[12],t.elements[7]=this.elements[13],t.elements[11]=this.elements[14],t.elements[15]=this.elements[15],t},e.prototype.inverse=function(){var e=this.getInverseMatrix();this.setMatrixByOther(e)},e.prototype.getInverseMatrix=function(){var t=this.elements,r=new e,i=r.elements,n=t[0],o=t[1],a=t[2],s=t[3],l=t[4],h=t[5],u=t[6],c=t[7],v=t[8],f=t[9],d=t[10],p=t[11],g=t[12],m=t[13],T=t[14],y=t[15],w=n*h-o*l,E=n*u-a*l,L=n*c-s*l,x=o*u-a*h,M=o*c-s*h,R=a*c-s*u,C=v*m-f*g,_=v*T-d*g,b=v*y-p*g,I=f*T-d*m,A=f*y-p*m,P=d*y-p*T,B=w*P-E*A+L*I+x*b-M*_+R*C;return B?(B=1/B,i[0]=(h*P-u*A+c*I)*B,i[1]=(-o*P+a*A-s*I)*B,i[2]=(m*R-T*M+y*x)*B,i[3]=(-f*R+d*M-p*x)*B,i[4]=(-l*P+u*b-c*_)*B,i[5]=(n*P-a*b+s*_)*B,i[6]=(-g*R+T*L-y*E)*B,i[7]=(v*R-d*L+p*E)*B,i[8]=(l*A-h*b+c*C)*B,i[9]=(-n*A+o*b-s*C)*B,i[10]=(g*M-m*L+y*w)*B,i[11]=(-v*M+f*L-p*w)*B,i[12]=(-l*I+h*_-u*C)*B,i[13]=(n*I-o*_+a*C)*B,i[14]=(-g*x+m*E-T*w)*B,i[15]=(v*x-f*E+d*w)*B,r):(console.log("can't get inverse matrix"),null)},e.prototype.setMatrixByOther=function(t){if(!(t instanceof e))throw"invalid otherMatrix";for(var r=0;r<t.elements.length;r++)this.elements[r]=t.elements[r]},e.prototype.setUnitMatrix=function(){this.setElements(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},e.prototype.isUnitMatrix=function(){for(var e=this.elements,t=0;t<e.length;t++)if(t%4===0){if(1!=e[t])return!1}else if(0!==e[t])return!1;return!0},e.prototype.clone=function(){return new e(this.elements[0],this.elements[4],this.elements[8],this.elements[12],this.elements[1],this.elements[5],this.elements[9],this.elements[13],this.elements[2],this.elements[6],this.elements[10],this.elements[14],this.elements[3],this.elements[7],this.elements[11],this.elements[15])},e.prototype.multiplyMatrix=function(t){var r=this.elements,i=t.elements,n=r[0]*i[0]+r[4]*i[1]+r[8]*i[2]+r[12]*i[3],o=r[0]*i[4]+r[4]*i[5]+r[8]*i[6]+r[12]*i[7],a=r[0]*i[8]+r[4]*i[9]+r[8]*i[10]+r[12]*i[11],s=r[0]*i[12]+r[4]*i[13]+r[8]*i[14]+r[12]*i[15],l=r[1]*i[0]+r[5]*i[1]+r[9]*i[2]+r[13]*i[3],h=r[1]*i[4]+r[5]*i[5]+r[9]*i[6]+r[13]*i[7],u=r[1]*i[8]+r[5]*i[9]+r[9]*i[10]+r[13]*i[11],c=r[1]*i[12]+r[5]*i[13]+r[9]*i[14]+r[13]*i[15],v=r[2]*i[0]+r[6]*i[1]+r[10]*i[2]+r[14]*i[3],f=r[2]*i[4]+r[6]*i[5]+r[10]*i[6]+r[14]*i[7],d=r[2]*i[8]+r[6]*i[9]+r[10]*i[10]+r[14]*i[11],p=r[2]*i[12]+r[6]*i[13]+r[10]*i[14]+r[14]*i[15],g=r[3]*i[0]+r[7]*i[1]+r[11]*i[2]+r[15]*i[3],m=r[3]*i[4]+r[7]*i[5]+r[11]*i[6]+r[15]*i[7],T=r[3]*i[8]+r[7]*i[9]+r[11]*i[10]+r[15]*i[11],y=r[3]*i[12]+r[7]*i[13]+r[11]*i[14]+r[15]*i[15];return new e(n,o,a,s,l,h,u,c,v,f,d,p,g,m,T,y)},e.prototype.multiplyColumn=function(e){var t=4==e.length;if(!t)throw"invalid c";var r=this.elements,i=e,n=r[0]*i[0]+r[4]*i[1]+r[8]*i[2]+r[12]*i[3],o=r[1]*i[0]+r[5]*i[1]+r[9]*i[2]+r[13]*i[3],a=r[2]*i[0]+r[6]*i[1]+r[10]*i[2]+r[14]*i[3],s=r[3]*i[0]+r[7]*i[1]+r[11]*i[2]+r[15]*i[3];return[n,o,a,s]},e.prototype.divide=function(e){if(0===e)throw"invalid a:a is 0";if(0!==e)for(var t=0,r=this.elements.length;t<r;t++)this.elements[t]/=e},e.prototype.getPosition=function(){return this.getColumnTrans()},e.prototype.worldTranslate=function(e,t,r){this.elements[12]+=e,this.elements[13]+=t,this.elements[14]+=r},e.prototype.localTranslate=function(e,t,r){var i=[e,t,r,1],n=this.multiplyColumn(i),o=this.getPosition();this.worldTranslate(n[0]-o.x,n[1]-o.y,n[2]-o.z)},e.prototype.worldScale=function(t,r,i){t=void 0!==t?t:1,r=void 0!==r?r:1,i=void 0!==i?i:1;var n=new e(t,0,0,0,0,r,0,0,0,0,i,0,0,0,0,1),o=n.multiplyMatrix(this);this.setMatrixByOther(o)},e.prototype.localScale=function(e,t,r){var i=this.getColumnTrans();this.setColumnTrans(0,0,0),this.worldScale(e,t,r),this.setColumnTrans(i.x,i.y,i.z)},e.prototype.worldRotateX=function(t){var r=Math.cos(t),i=Math.sin(t),n=new e(1,0,0,0,0,r,(-i),0,0,i,r,0,0,0,0,1),o=n.multiplyMatrix(this);this.setMatrixByOther(o)},e.prototype.worldRotateY=function(t){var r=Math.cos(t),i=Math.sin(t),n=new e(r,0,i,0,0,1,0,0,(-i),0,r,0,0,0,0,1),o=n.multiplyMatrix(this);this.setMatrixByOther(o)},e.prototype.worldRotateZ=function(t){var r=Math.cos(t),i=Math.sin(t),n=new e(r,(-i),0,0,i,r,0,0,0,0,1,0,0,0,0,1),o=n.multiplyMatrix(this);this.setMatrixByOther(o)},e.prototype.worldRotateByVector=function(t,r){var i,n,o,a,s,l,h,u,c,v,f,d,p,g=r.x,m=r.y,T=r.z;n=Math.sin(t),o=Math.cos(t),i=Math.sqrt(g*g+m*m+T*T),g/=i,m/=i,T/=i,a=g*g,s=m*m,l=T*T,h=g*m,u=m*T,c=T*g,v=g*n,f=m*n,d=T*n,p=1-o;var y=p*a+o,w=p*h-d,E=p*c+f,L=0,x=p*h+d,M=p*s+o,R=p*u-v,C=0,_=p*c-f,b=p*u+v,I=p*l+o,A=0,P=0,B=0,V=0,D=1,N=new e(y,w,E,L,x,M,R,C,_,b,I,A,P,B,V,D),O=N.multiplyMatrix(this);this.setMatrixByOther(O)},e.prototype.localRotateX=function(e){var t=this.getColumnTrans();this.setColumnTrans(0,0,0);var r=this.getColumnX();this.worldRotateByVector(e,r),this.setColumnTrans(t.x,t.y,t.z)},e.prototype.localRotateY=function(e){var t=this.getColumnTrans();this.setColumnTrans(0,0,0);var r=this.getColumnY();this.worldRotateByVector(e,r),this.setColumnTrans(t.x,t.y,t.z)},e.prototype.localRotateZ=function(e){var t=this.getColumnTrans();this.setColumnTrans(0,0,0);var r=this.getColumnZ();this.worldRotateByVector(e,r),this.setColumnTrans(t.x,t.y,t.z)},e.prototype.localRotateByVector=function(e,t){var r=t.getArray();r.push(1);var n=this.multiplyColumn(r),o=new i(n[0],n[1],n[2]),a=this.getColumnTrans();this.setColumnTrans(0,0,0),this.worldRotateByVector(e,o),this.setColumnTrans(a.x,a.y,a.z)},e}();return n}),define("world/TextureMaterial",["require","exports","world/Kernel"],function(e,t,r){"use strict";var i=function(){function e(e){this.texture=null,this.image=null,this.loaded=!1,this.delete=!1,this.texture=r.gl.createTexture(),this.image=null,this.loaded=!1,this.delete=!1,e.image instanceof Image&&e.image.width>0&&e.image.height>0?this.setImage(e.image):"string"==typeof e.url&&this.setImageUrl(e.url)}return e.prototype.setImage=function(e){e.width>0&&e.height>0&&(this.image=e,this.onLoad())},e.prototype.setImageUrl=function(e){this.image=new Image,this.image.crossOrigin="anonymous",this.image.onload=this.onLoad.bind(this),this.image.src=e},e.prototype.onLoad=function(){this.delete||(r.gl.bindTexture(r.gl.TEXTURE_2D,this.texture),r.gl.pixelStorei(r.gl.UNPACK_FLIP_Y_WEBGL,1),r.gl.texImage2D(r.gl.TEXTURE_2D,0,r.gl.RGBA,r.gl.RGBA,r.gl.UNSIGNED_BYTE,this.image),r.gl.texParameteri(r.gl.TEXTURE_2D,r.gl.TEXTURE_MIN_FILTER,r.gl.LINEAR_MIPMAP_NEAREST),r.gl.texParameteri(r.gl.TEXTURE_2D,r.gl.TEXTURE_MAG_FILTER,r.gl.LINEAR),r.gl.texParameteri(r.gl.TEXTURE_2D,r.gl.TEXTURE_WRAP_S,r.gl.CLAMP_TO_EDGE),r.gl.texParameteri(r.gl.TEXTURE_2D,r.gl.TEXTURE_WRAP_T,r.gl.CLAMP_TO_EDGE),r.gl.generateMipmap(r.gl.TEXTURE_2D),r.gl.bindTexture(r.gl.TEXTURE_2D,null),this.loaded=!0)},e.prototype.releaseTexture=function(){r.gl.isTexture(this.texture)&&(r.gl.deleteTexture(this.texture),this.delete=!0)},e}();return i}),define("world/Object3D",["require","exports","world/Kernel","world/Matrix","world/TextureMaterial"],function(e,t,r,i,n){"use strict";var o=function(){function e(e){this.id=++r.idCounter,this.matrix=new i,this.parent=null,this.vertices=[],this.vertexBuffer=null,this.indices=[],this.indexBuffer=null,this.textureCoords=[],this.textureCoordBuffer=null,this.material=null,this.visible=!0,e&&e.material&&(this.material=e.material),this.createVerticeData(e)}return e.prototype.createVerticeData=function(e){},e.prototype.setBuffers=function(e){e&&(this.vertices=e.vertices||[],this.indices=e.indices||[],this.textureCoords=e.textureCoords||[],this.vertices.length>0&&this.indices.length>0&&(r.gl.isBuffer(this.vertexBuffer)||(this.vertexBuffer=r.gl.createBuffer()),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,this.vertexBuffer),r.gl.bufferData(r.gl.ARRAY_BUFFER,new Float32Array(this.vertices),r.gl.STATIC_DRAW),r.gl.isBuffer(this.indexBuffer)||(this.indexBuffer=r.gl.createBuffer()),r.gl.bindBuffer(r.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.gl.bufferData(r.gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),r.gl.STATIC_DRAW)),this.material instanceof n&&this.textureCoords.length>0&&(r.gl.isBuffer(this.textureCoordBuffer)||(this.textureCoordBuffer=r.gl.createBuffer()),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,this.textureCoordBuffer),r.gl.bufferData(r.gl.ARRAY_BUFFER,new Float32Array(this.textureCoords),r.gl.STATIC_DRAW))),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,null),r.gl.bindBuffer(r.gl.ELEMENT_ARRAY_BUFFER,null)},e.prototype.setShaderMatrix=function(e){e.viewMatrix=e.viewMatrix instanceof i?e.viewMatrix:e.getViewMatrix();var t=e.viewMatrix.multiplyMatrix(this.matrix);r.gl.uniformMatrix4fv(r.gl.shaderProgram.uMVMatrix,!1,t.elements),r.gl.uniformMatrix4fv(r.gl.shaderProgram.uPMatrix,!1,e.projMatrix.elements)},e.prototype.draw=function(e){this.visible&&this.material instanceof n&&this.material.loaded&&(r.gl.enableVertexAttribArray(r.gl.shaderProgram.aTextureCoord),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,this.textureCoordBuffer),r.gl.vertexAttribPointer(r.gl.shaderProgram.aTextureCoord,2,r.gl.FLOAT,!1,0,0),r.gl.activeTexture(r.gl.TEXTURE0),r.gl.bindTexture(r.gl.TEXTURE_2D,this.material.texture),r.gl.uniform1i(r.gl.shaderProgram.uSampler,0),this.setShaderMatrix(e),r.gl.enableVertexAttribArray(r.gl.shaderProgram.aVertexPosition),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,this.vertexBuffer),r.gl.vertexAttribPointer(r.gl.shaderProgram.aVertexPosition,3,r.gl.FLOAT,!1,0,0),r.gl.bindBuffer(r.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer),r.gl.drawElements(r.gl.TRIANGLES,this.indices.length,r.gl.UNSIGNED_SHORT,0),r.gl.bindBuffer(r.gl.ARRAY_BUFFER,null),r.gl.bindBuffer(r.gl.ELEMENT_ARRAY_BUFFER,null),r.gl.bindTexture(r.gl.TEXTURE_2D,null))},e.prototype.releaseBuffers=function(){r.gl.isBuffer(this.vertexBuffer)&&r.gl.deleteBuffer(this.vertexBuffer),r.gl.isBuffer(this.indexBuffer)&&r.gl.deleteBuffer(this.indexBuffer),r.gl.isBuffer(this.textureCoordBuffer)&&r.gl.deleteBuffer(this.textureCoordBuffer),this.vertexBuffer=null,this.indexBuffer=null,this.textureCoordBuffer=null},e.prototype.destroy=function(){this.parent=null,this.releaseBuffers(),this.material instanceof n&&(this.material.releaseTexture(),this.material=null)},e.prototype.getPosition=function(){var e=this.matrix.getPosition();return e},e.prototype.setPosition=function(e,t,r){this.matrix.setColumnTrans(e,t,r)},e.prototype.worldTranslate=function(e,t,r){this.matrix.worldTranslate(e,t,r)},e.prototype.localTranslate=function(e,t,r){this.matrix.localTranslate(e,t,r)},e.prototype.worldScale=function(e,t,r){this.matrix.worldScale(e,t,r)},e.prototype.localScale=function(e,t,r){this.matrix.localScale(e,t,r)},e.prototype.worldRotateX=function(e){this.matrix.worldRotateX(e)},e.prototype.worldRotateY=function(e){this.matrix.worldRotateY(e)},e.prototype.worldRotateZ=function(e){this.matrix.worldRotateZ(e)},e.prototype.worldRotateByVector=function(e,t){this.matrix.worldRotateByVector(e,t)},e.prototype.localRotateX=function(e){this.matrix.localRotateX(e)},e.prototype.localRotateY=function(e){this.matrix.localRotateY(e)},e.prototype.localRotateZ=function(e){this.matrix.localRotateZ(e)},e.prototype.localRotateByVector=function(e,t){this.matrix.localRotateByVector(e,t)},e.prototype.getXAxisDirection=function(){var e=this.matrix.getColumnX();return e.normalize(),e},e.prototype.getYAxisDirection=function(){var e=this.matrix.getColumnY();return e.normalize(),e},e.prototype.getZAxisDirection=function(){var e=this.matrix.getColumnZ();return e.normalize(),e},e}();return o}),define("world/PerspectiveCamera",["require","exports","world/Kernel","world/Utils","world/Math","world/Vertice","world/Vector","world/Line","world/TileGrid","world/Matrix","world/Object3D"],function(e,t,r,i,n,o,a,s,l,h,u){"use strict";var c=function(e){function t(t,r,i,n){void 0===t&&(t=90),void 0===r&&(r=1),void 0===i&&(i=1),void 0===n&&(n=1),e.call(this,null),this.fov=t,this.aspect=r,this.near=i,this.far=n,this.Enum={EARTH_FULL_OVERSPREAD_SCREEN:"EARTH_FULL_OVERSPREAD_SCREEN",EARTH_NOT_FULL_OVERSPREAD_SCREEN:"EARTH_NOT_FULL_OVERSPREAD_SCREEN"},this.animating=!1,this.pitch=90,this.projMatrix=new h,this.setPerspectiveMatrix(this.fov,this.aspect,this.near,this.far)}return __extends(t,e),t.prototype.setPerspectiveMatrix=function(e,t,r,i){void 0===e&&(e=90),void 0===t&&(t=1),void 0===r&&(r=1),void 0===i&&(i=1),this.fov=e,this.aspect=t,this.near=r,this.far=i;var n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],o=this.fov*Math.PI/180/2,a=1/Math.tan(o),s=this.far-this.near;n[0]=a/this.aspect,n[5]=a,n[10]=-(this.far+this.near)/s,n[11]=-1,n[14]=-2*this.near*this.far/s,n[15]=0,this.projMatrix.setElements(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15])},t.prototype.getLightDirection=function(){var e=this.matrix.getColumnZ(),t=new a((-e.x),(-e.y),(-e.z));return t.normalize(),t},t.prototype.getProjViewMatrix=function(){var e=this.getViewMatrix(),t=this.projMatrix.multiplyMatrix(e);return t},t.prototype.setFov=function(e){if(!(e>0))throw"invalid fov:"+e;this.setPerspectiveMatrix(e,this.aspect,this.near,this.far)},t.prototype.setAspect=function(e){if(!(e>0))throw"invalid aspect:"+e;this.setPerspectiveMatrix(this.fov,e,this.near,this.far)},t.prototype.setNear=function(e){if(!(e>0))throw"invalid near:"+e;this.setPerspectiveMatrix(this.fov,this.aspect,e,this.far)},t.prototype.setFar=function(e){if(!(e>0))throw"invalid far:"+e;this.setPerspectiveMatrix(this.fov,this.aspect,this.near,e)},t.prototype.getViewMatrix=function(){return this.matrix.getInverseMatrix()},t.prototype.look=function(e,t,r){
void 0===r&&(r=new a(0,1,0));var i=e.clone(),n=t.clone(),o=r.clone(),s=i.x,l=i.y,h=i.z,u=new a(i.x-n.x,i.y-n.y,i.z-n.z).normalize(),c=o.cross(u).normalize(),v=u.cross(c).normalize();this.matrix.setColumnX(c.x,c.y,c.z),this.matrix.setColumnY(v.x,v.y,v.z),this.matrix.setColumnZ(u.x,u.y,u.z),this.matrix.setColumnTrans(s,l,h),this.matrix.setLastRowDefault();var f=i.x-n.x,d=i.y-n.y,p=i.z-n.z,g=Math.sqrt(f*f+d*d+p*p);this.setFar(g)},t.prototype.lookAt=function(e,t){var r=e.clone(),i=this.getPosition();this.look(i,r,t)},t.prototype.convertVerticeFromWorldToNDC=function(e,t){t instanceof h||(t=this.getProjViewMatrix());var r=[e.x,e.y,e.z,1],i=t.multiplyColumn(r),n=i[3],a=[];a[0]=i[0]/n,a[1]=i[1]/n,a[2]=i[2]/n,a[3]=1;var s=new o(a[0],a[1],a[2]);return s},t.prototype.convertVerticeFromNdcToWorld=function(e){var t=[e.x,e.y,e.z,1],r=this.projMatrix.getInverseMatrix(),i=r.multiplyColumn(t),n=i[0]/i[3],a=i[1]/i[3],s=i[2]/i[3],l=1,h=[n,a,s,l],u=this.getViewMatrix(),c=u.getInverseMatrix(),v=c.multiplyColumn(h),f=new o(v[0],v[1],v[2]);return f},t.prototype.convertVerticeFromCameraToWorld=function(e,t){t instanceof h||(t=this.getViewMatrix());var r=e.clone(),i=t.getInverseMatrix(),n=[r.x,r.y,r.z,1],a=i.multiplyColumn(n),s=new o(a[0],a[1],a[2]);return s},t.prototype.convertVectorFromCameraToWorld=function(e,t){if(!(e instanceof a))throw"invalid vectorInCamera: not Vector";t instanceof h||(t=this.getViewMatrix());var r=e.clone(),i=r.getVertice(),n=this.convertVerticeFromCameraToWorld(i,t),o=this.getPosition(),s=a.verticeMinusVertice(n,o);return s.normalize(),s},t.prototype.getPickDirectionByCanvas=function(e,t){var r=n.convertPointFromCanvasToNDC(e,t),i=this.getPickDirectionByNDC(r[0],r[1]);return i},t.prototype.getDirectionIntersectPointWithEarth=function(){var e=this.getLightDirection(),t=this.getPosition(),r=new s(t,e),i=this.getPickCartesianCoordInEarthByLine(r);return i},t.prototype.getPickDirectionByNDC=function(e,t){var r=new o(e,t,.499),i=this.convertVerticeFromNdcToWorld(r),n=this.getPosition(),s=a.verticeMinusVertice(i,n);return s.normalize(),s},t.prototype.getPickCartesianCoordInEarthByLine=function(e){var t=[],r=n.getLineIntersectPointWithEarth(e);if(0===r.length)t=[];else if(1==r.length)t=r;else if(2==r.length){var i=r[0],o=r[1],a=this.getPosition(),s=n.getLengthFromVerticeToVertice(a,i),l=n.getLengthFromVerticeToVertice(a,o);t=s<=l?[i,o]:[o,i]}return t},t.prototype.getPickCartesianCoordInEarthByCanvas=function(e,t){var r=this.getPickDirectionByCanvas(e,t),i=this.getPosition(),n=new s(i,r),o=this.getPickCartesianCoordInEarthByLine(n);return o},t.prototype.getPickCartesianCoordInEarthByNDC=function(e,t){var r=this.getPickDirectionByNDC(e,t),i=this.getPosition(),n=new s(i,r),o=this.getPickCartesianCoordInEarthByLine(n);return o},t.prototype.getPlanXOZ=function(){var e=this.getPosition(),t=this.getLightDirection(),r=n.getCrossPlaneByLine(e,t);return r},t.prototype.isAnimating=function(){return this.animating},t.prototype.animateToLevel=function(e){var t=this._animateToLevel(e);this._animateToMatrix(t,function(){r.globe.CURRENT_LEVEL=e})},t.prototype._animateToMatrix=function(e,t){var r=this;if(!this.isAnimating()){this.animating=!0;var i=this.getPosition(),n=e.getPosition(),o=1e3,a=1e3/60,s=Math.floor(o/a),l=(n.x-i.x)/s,h=(n.y-i.y)/s,u=(n.z-i.z)/s,c=-1,v=function(i){c<0&&(c=i);var n=i-c;if(n>=o)r.matrix=e,r.animating=!1,t();else{var a=r.getPosition();r.setPosition(a.x+l,a.y+h,a.z+u),requestAnimationFrame(v)}};requestAnimationFrame(v)}},t.prototype._animateToLevel=function(e){if(!i.isNonNegativeInteger(e))throw"invalid level:"+e;var t=this._clone();return t._setLevel(e),t.matrix},t.prototype._clone=function(){var e=new t;return e.pitch=this.pitch,e.matrix=this.matrix.clone(),e.projMatrix=this.projMatrix.clone(),e},t.prototype.setLevel=function(e){this._setLevel(e),r.globe.CURRENT_LEVEL=e},t.prototype._setLevel=function(e){if(!i.isNonNegativeInteger(e))throw"invalid level:"+e;var t=this.getPosition();if(0===t.x&&0===t.y&&0===t.z){var s=n.getLengthFromCamera2EarthSurface(e)+r.EARTH_RADIUS,l=new o(0,0,0),h=this.getLightDirection().getOpposite();h.setLength(s);var u=h.getVertice();this.look(u,l)}else{var c=n.getLengthFromCamera2EarthSurface(r.globe.CURRENT_LEVEL),v=n.getLengthFromCamera2EarthSurface(e),f=c-v,d=this.getLightDirection();d.setLength(f);var p=a.verticePlusVector(t,d);this.setPosition(p.x,p.y,p.z)}},t.prototype.isWorldVerticeVisibleInCanvas=function(e,t){if(!(e instanceof o))throw"invalid verticeInWorld: not Vertice";t=t||{};var r="number"==typeof t.threshold?Math.abs(t.threshold):1,i=this.getPosition(),l=a.verticeMinusVertice(e,i),u=new s(i,l),c=this.getPickCartesianCoordInEarthByLine(u);if(c.length>0){var v=c[0],f=n.getLengthFromVerticeToVertice(i,e),d=n.getLengthFromVerticeToVertice(i,v);if(f<d+5){t.verticeInNDC instanceof o||(t.projView instanceof h||(t.projView=this.getProjViewMatrix()),t.verticeInNDC=this.convertVerticeFromWorldToNDC(e,t.projView));var p=t.verticeInNDC.x>=-1&&t.verticeInNDC.x<=1&&t.verticeInNDC.y>=-r&&t.verticeInNDC.y<=1;return p}}return!1},t.prototype.isGeoVisibleInCanvas=function(e,t,r){var i=n.geographicToCartesianCoord(e,t),o=this.isWorldVerticeVisibleInCanvas(i,r);return o},t.prototype.getVisibleTilesByLevel=function(e,t){function r(e){return!!(e.area>=5e3&&e.clockwise&&e.visibleCount>=1)}function i(i,o){var h=[],u=new l(e,i,o),c=this.getTileVisibleInfo(u.level,u.row,u.column,t),v=r(c);if(v){u.visibleInfo=c,h.push(u);for(var f,d=0,p=o;d<a&&(d++,u=l.getTileGridByBrother(e,i,p,n.LEFT,s),p=u.column,c=this.getTileVisibleInfo(u.level,u.row,u.column,t),f=r(c));)u.visibleInfo=c,h.push(u);for(var g=0,m=o;g<a&&(g++,u=l.getTileGridByBrother(e,i,m,n.RIGHT,s),m=u.column,c=this.getTileVisibleInfo(u.level,u.row,u.column,t),f=r(c));)u.visibleInfo=c,h.push(u)}return h}if(!(e>=0))throw"invalid level";var o=[];t=t||{},t.projView instanceof h||(t.projView=this.getProjViewMatrix());var a=Math.min(10,Math.pow(2,e)-1),s={maxSize:Math.pow(2,e)},u=this._getVerticalVisibleCenterInfo(t),c=l.getTileGridByGeo(u.lon,u.lat,e),v=i.bind(this),f=v(c.row,c.column);o=o.concat(f);for(var d,p=0,g=c.row;p<a&&(p++,d=l.getTileGridByBrother(e,g,c.column,n.BOTTOM,s),g=d.row,f=v(d.row,d.column),f.length>0);)o=o.concat(f);for(var m=0,T=c.row;m<a&&(m++,d=l.getTileGridByBrother(e,T,c.column,n.TOP,s),T=d.row,f=v(d.row,d.column),f.length>0);)o=o.concat(f);return o},t.prototype.getTileVisibleInfo=function(e,t,i,o){if(!(e>=0))throw"invalid level";if(!(t>=0))throw"invalid row";if(!(i>=0))throw"invalid column";o=o||{};var s="number"==typeof o.threshold?Math.abs(o.threshold):1,l={lb:{lon:null,lat:null,verticeInWorld:null,verticeInNDC:null,visible:!1},lt:{lon:null,lat:null,verticeInWorld:null,verticeInNDC:null,visible:!1},rt:{lon:null,lat:null,verticeInWorld:null,verticeInNDC:null,visible:!1},rb:{lon:null,lat:null,verticeInWorld:null,verticeInNDC:null,visible:!1},Egeo:null,visibleCount:0,clockwise:!1,width:null,height:null,area:null};o.projView instanceof h||(o.projView=this.getProjViewMatrix()),l.Egeo=n.getTileGeographicEnvelopByGrid(e,t,i);var u=l.Egeo.minLon,c=l.Egeo.maxLon,v=l.Egeo.minLat,f=l.Egeo.maxLat;l.lb.lon=u,l.lb.lat=v,l.lb.verticeInWorld=n.geographicToCartesianCoord(l.lb.lon,l.lb.lat),l.lb.verticeInNDC=this.convertVerticeFromWorldToNDC(l.lb.verticeInWorld,o.projView),l.lb.visible=this.isWorldVerticeVisibleInCanvas(l.lb.verticeInWorld,{verticeInNDC:l.lb.verticeInNDC,projView:o.projView,threshold:s}),l.lb.visible&&l.visibleCount++,l.lt.lon=u,l.lt.lat=f,l.lt.verticeInWorld=n.geographicToCartesianCoord(l.lt.lon,l.lt.lat),l.lt.verticeInNDC=this.convertVerticeFromWorldToNDC(l.lt.verticeInWorld,o.projView),l.lt.visible=this.isWorldVerticeVisibleInCanvas(l.lt.verticeInWorld,{verticeInNDC:l.lt.verticeInNDC,projView:o.projView,threshold:s}),l.lt.visible&&l.visibleCount++,l.rt.lon=c,l.rt.lat=f,l.rt.verticeInWorld=n.geographicToCartesianCoord(l.rt.lon,l.rt.lat),l.rt.verticeInNDC=this.convertVerticeFromWorldToNDC(l.rt.verticeInWorld,o.projView),l.rt.visible=this.isWorldVerticeVisibleInCanvas(l.rt.verticeInWorld,{verticeInNDC:l.rt.verticeInNDC,projView:o.projView,threshold:s}),l.rt.visible&&l.visibleCount++,l.rb.lon=c,l.rb.lat=v,l.rb.verticeInWorld=n.geographicToCartesianCoord(l.rb.lon,l.rb.lat),l.rb.verticeInNDC=this.convertVerticeFromWorldToNDC(l.rb.verticeInWorld,o.projView),l.rb.visible=this.isWorldVerticeVisibleInCanvas(l.rb.verticeInWorld,{verticeInNDC:l.rb.verticeInNDC,projView:o.projView,threshold:s}),l.rb.visible&&l.visibleCount++;var d=[l.lb.verticeInNDC,l.lt.verticeInNDC,l.rt.verticeInNDC,l.rb.verticeInNDC],p=a.verticeMinusVertice(d[3],d[0]);p.z=0;var g=a.verticeMinusVertice(d[1],d[0]);g.z=0;var m=p.cross(g);l.clockwise=m.z>0;var T=Math.sqrt(Math.pow(d[1].x-d[2].x,2)+Math.pow(d[1].y-d[2].y,2))*r.canvas.width/2,y=Math.sqrt(Math.pow(d[0].x-d[3].x,2)+Math.pow(d[0].y-d[3].y,2))*r.canvas.width/2;l.width=Math.floor((T+y)/2);var w=Math.sqrt(Math.pow(d[0].x-d[1].x,2)+Math.pow(d[0].y-d[1].y,2))*r.canvas.height/2,E=Math.sqrt(Math.pow(d[2].x-d[3].x,2)+Math.pow(d[2].y-d[3].y,2))*r.canvas.height/2;return l.height=Math.floor((w+E)/2),l.area=l.width*l.height,l},t.prototype._getVerticalVisibleCenterInfo=function(e){e=e||{},e.projView||(e.projView=this.getProjViewMatrix());var t,r={ndcY:null,pIntersect:null,lon:null,lat:null};if(90==this.pitch)r.ndcY=0;else{var i,o=10,a=2/o,s=1,l=-1;for(i=1;i>=-1;i-=a)if(t=this.getPickCartesianCoordInEarthByNDC(0,i),t.length>0){s=i;break}for(i=-1;i<=1;i+=a)if(t=this.getPickCartesianCoordInEarthByNDC(0,i),t.length>0){l=i;break}r.ndcY=(s+l)/2}t=this.getPickCartesianCoordInEarthByNDC(0,r.ndcY),r.pIntersect=t[0];var h=n.cartesianCoordToGeographic(r.pIntersect);return r.lon=h[0],r.lat=h[1],r},t}(u);return c}),define("world/Event",["require","exports","world/Kernel","world/Math","world/Vector"],function(e,t,r,i,n){"use strict";var o={canvas:HTMLCanvasElement,bMouseDown:!1,dragGeo:null,previousX:-1,previousY:-1,onMouseMoveListener:null,bindEvents:function(e){this.canvas=e,this.onMouseMoveListener=this.onMouseMove.bind(this),window.addEventListener("resize",this.initLayout.bind(this)),this.canvas.addEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.addEventListener("dblclick",this.onDbClick.bind(this)),this.canvas.addEventListener("mousewheel",this.onMouseWheel.bind(this)),this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this)),document.body.addEventListener("keydown",this.onKeyDown.bind(this))},initLayout:function(){this.canvas instanceof HTMLCanvasElement&&(this.canvas.width=document.body.clientWidth,this.canvas.height=document.body.clientHeight,r.globe&&(r.globe.camera.setAspect(this.canvas.width/this.canvas.height),r.globe.refresh()))},moveLonLatToCanvas:function(e,t,n,o){var a=r.globe.camera.getPickCartesianCoordInEarthByCanvas(n,o);if(a.length>0){var s=i.cartesianCoordToGeographic(a[0]),l=s[0],h=s[1];this.moveGeo(e,t,l,h)}},onMouseDown:function(e){if(r.globe){this.bMouseDown=!0,this.previousX=e.layerX||e.offsetX,this.previousY=e.layerY||e.offsetY;var t=r.globe.camera.getPickCartesianCoordInEarthByCanvas(this.previousX,this.previousY);t.length>0&&(this.dragGeo=i.cartesianCoordToGeographic(t[0]),console.log("单击点三维坐标:("+t[0].x+","+t[0].y+","+t[0].z+");经纬度坐标:["+this.dragGeo[0]+","+this.dragGeo[1]+"]")),this.canvas.addEventListener("mousemove",this.onMouseMoveListener,!1)}},onMouseMove:function(e){var t=r.globe;if(t&&this.bMouseDown){var n=e.layerX||e.offsetX,o=e.layerY||e.offsetY,a=t.camera.getPickCartesianCoordInEarthByCanvas(n,o);if(a.length>0){if(this.dragGeo){var s=i.cartesianCoordToGeographic(a[0]);this.moveGeo(this.dragGeo[0],this.dragGeo[1],s[0],s[1])}else this.dragGeo=i.cartesianCoordToGeographic(a[0]);this.previousX=n,this.previousY=o,this.canvas.style.cursor="pointer"}else this.previousX=-1,this.previousY=-1,this.dragGeo=null,this.canvas.style.cursor="default"}},moveGeo:function(e,t,o,a){if(e!==o||t!==a){var s=i.geographicToCartesianCoord(e,t),l=n.fromVertice(s);l.normalize();var h=i.geographicToCartesianCoord(o,a),u=n.fromVertice(h);u.normalize();var c=l.cross(u),v=-Math.acos(l.dot(u)),f=r.globe.camera;f.worldRotateByVector(v,c)}},onMouseUp:function(){this.bMouseDown=!1,this.previousX=-1,this.previousY=-1,this.dragGeo=null,this.canvas instanceof HTMLCanvasElement&&(this.canvas.removeEventListener("mousemove",this.onMouseMoveListener,!1),this.canvas.style.cursor="default")},onDbClick:function(e){var t=r.globe;if(t){var n=e.layerX||e.offsetX,o=e.layerY||e.offsetY,a=t.camera.getPickCartesianCoordInEarthByCanvas(n,o);if(t.setLevel(t.CURRENT_LEVEL+1),a.length>=1){var s=a[0],l=i.cartesianCoordToGeographic(s),h=l[0],u=l[1];t.setLevel(t.CURRENT_LEVEL+1),this.moveLonLatToCanvas(h,u,n,o)}}},onMouseWheel:function(e){var t=r.globe;if(t){var i,n=0;e.wheelDelta?(i=e.wheelDelta,n=parseInt(i/120)):e.detail&&(i=e.detail,n=-parseInt(i/3));var o=t.CURRENT_LEVEL+n;o>=0&&t.animateToLevel(o)}},onKeyDown:function(e){var t=r.globe;if(t){var o=36,a=2,s=t.camera,l=void 0!==e.keyCode?e.keyCode:e.which;if(38==l||40==l){if(38==l){if(s.pitch<=o)return}else if(40==l){if(s.pitch>=90)return;a*=-1}var h=s.getDirectionIntersectPointWithEarth();if(h.length>0){var u=h[0],c=s.getPosition(),v=i.getLengthFromVerticeToVertice(c,u),f=s.matrix.clone();f.setColumnTrans(u.x,u.y,u.z);var d=i.degreeToRadian(a);f.localRotateX(d);var p=f.getColumnZ();p.setLength(v);var g=n.verticePlusVector(u,p);s.look(g,u),s.pitch-=a,t.refresh()}else alert("视线与地球无交点")}}}};return o}),define("world/Object3DComponents",["require","exports","world/Kernel","world/Matrix"],function(e,t,r,i){"use strict";var n=function(){function e(){this.id=++r.idCounter,this.matrix=new i,this.visible=!0,this.parent=null,this.children=[]}return e.prototype.add=function(e){return null!==this.findObjById(e.id)?void console.debug("obj已经存在于Object3DComponents中，无法将其再次加入！"):(this.children.push(e),void(e.parent=this))},e.prototype.remove=function(e){if(e){var t=this.findObjById(e.id);return null===t?(console.debug("obj不存在于Object3DComponents中，所以无法将其从中删除！"),!1):(e.destroy(),this.children.splice(t.index,1),e=null,!0)}return!1},e.prototype.clear=function(){for(var e=0;e<this.children.length;e++){var t=this.children[e];t.destroy()}this.children=[]},e.prototype.destroy=function(){this.parent=null,this.clear()},e.prototype.findObjById=function(e){for(var t=0;t<this.children.length;t++){var r=this.children[t];if(r.id==e)return r.index=t,r}return null},e.prototype.draw=function(e){for(var t=0;t<this.children.length;t++){var r=this.children[t];r&&r.visible&&r.draw(e)}},e.prototype.worldTranslate=function(e,t,r){this.matrix.worldTranslate(e,t,r)},e.prototype.localTranslate=function(e,t,r){this.matrix.localTranslate(e,t,r)},e.prototype.worldScale=function(e,t,r){this.matrix.worldScale(e,t,r)},e.prototype.localScale=function(e,t,r){this.matrix.localScale(e,t,r)},e.prototype.worldRotateX=function(e){this.matrix.worldRotateX(e)},e.prototype.worldRotateY=function(e){this.matrix.worldRotateY(e)},e.prototype.worldRotateZ=function(e){this.matrix.worldRotateZ(e)},e.prototype.worldRotateByVector=function(e,t){this.matrix.worldRotateByVector(e,t)},e.prototype.localRotateX=function(e){this.matrix.localRotateX(e)},e.prototype.localRotateY=function(e){this.matrix.localRotateY(e)},e.prototype.localRotateZ=function(e){this.matrix.localRotateZ(e)},e.prototype.localRotateByVector=function(e,t){this.matrix.localRotateByVector(e,t)},e}();return n}),define("world/Enum",["require","exports"],function(e,t){"use strict";var r;return function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.FULL_IN=1]="FULL_IN",e[e.FULL_OUT=2]="FULL_OUT",e[e.IN_OUT=3]="IN_OUT",e[e.NOKIA_TILED_MAP=4]="NOKIA_TILED_MAP",e[e.Google_TILED_MAP=5]="Google_TILED_MAP",e[e.OSM_TILED_MAP=6]="OSM_TILED_MAP",e[e.BLENDED_TILED_MAP=7]="BLENDED_TILED_MAP",e[e.GLOBE_TILE=8]="GLOBE_TILE",e[e.TERRAIN_TILE=9]="TERRAIN_TILE"}(r||(r={})),r}),define("world/Elevation",["require","exports","world/Kernel","world/Utils","world/Math","world/TileGrid"],function(e,t,r,i,n,o){"use strict";var a={elevationUrl:"//sampleserver4.arcgisonline.com/ArcGIS/rest/services/Elevation/ESRI_Elevation_World/MapServer/exts/ElevationsSOE/ElevationLayers/1/GetElevationData",elevations:{},factor:1,getAncestorElevationLevel:function(e){if(!(e>=0))throw"invalid level";var t=Math.floor((e-1-r.ELEVATION_LEVEL)/3),i=r.ELEVATION_LEVEL+3*t;return i},requestElevationsByTileGrid:function(e,t,r){function o(){if(4==x.readyState&&200==x.status)try{var e=JSON.parse(x.responseText);1==this.factor?this.elevations[s]=e.data:this.elevations[s]=i.map(this.elevations,function(e){return e*this.factor}.bind(this))}catch(e){console.error("requestElevationsByTileGrid_callback error",e)}}if(!(e>=0))throw"invalid level";if(!(t>=0))throw"invalid row";if(!(r>=0))throw"invalid column";var a=80,s=e+"_"+t+"_"+r;if(!this.elevations.hasOwnProperty(s)){this.elevations[s]=null;var l=n.getTileWebMercatorEnvelopeByGrid(e,t,r),h=l.minX,u=l.minY,c=l.maxX,v=l.maxY,f=(c-h)/a,d=(v-u)/a,p=f/2,g=d/2,m={xmin:h-p,ymin:u-g,xmax:c+p,ymax:v+g,spatialReference:{wkid:102100}},T=encodeURIComponent(JSON.stringify(m)),y=a+1,w=a+1,E="pjson",L="Extent="+T+"&Rows="+y+"&Columns="+w+"&f="+E,x=new XMLHttpRequest;x.onreadystatechange=o.bind(this),x.open("GET","proxy.jsp?"+this.elevationUrl+"?"+L,!0),x.send()}},getElevation:function(e,t,r){if(!(e>=0))throw"invalid level";if(!(t>=0))throw"invalid row";if(!(r>=0))throw"invalid column";var i=null,n=this.getExactElevation(e,t,r);return i=n?n:this.getLinearElevation(e,t,r)},getExactElevation:function(e,t,i){if(!(e>=0))throw"invalid level";if(!(t>=0))throw"invalid row";if(!(i>=0))throw"invalid column";var a=null,s=this.getAncestorElevationLevel(e),l=o.getTileGridAncestor(s,e,t,i),h=l.level+"_"+l.row+"_"+l.column,u=this.elevations[h];if(u instanceof Array&&u.length>0&&e>r.ELEVATION_LEVEL){for(var c={level:l.level,row:l.row,column:l.column};c.level!=e;)c=o.getTileGridByParent(c.level,c.row,c.column,n.LEFT_TOP);if(c.level==e){var v=t-c.row,f=i-c.column,d=81,p=s+3-e,g=Math.pow(2,p),m=v*g*10*d+f*g*10;a={sourceLevel:s,elevations:[]};for(var T=0;T<=10;T++){for(var y=m,w=0;w<=10;w++){var E=u[y];a.elevations.push(E),y+=g}m+=g*d}}}return a},getLinearElevation:function(e,t,r){if(!(e>=0))throw"invalid level";if(!(t>=0))throw"invalid row";if(!(r>=0))throw"invalid column";var i=null,n=this.getAncestorElevationLevel(e),a=o.getTileGridAncestor(n,e,t,r),s=this.getExactElevation(a.level,a.row,a.column),l=e-n;return s&&(i={sourceLevel:n-3,elevations:null},1==l?i.elevations=this.getLinearElevationFromParent(s,e,t,r):2==l?i.elevations=this.getLinearElevationFromParent2(s,e,t,r):3==l&&(i.elevations=this.getLinearElevationFromParent3(s,e,t,r))),i},getLinearElevationFromParent:function(e,t,r,i){if(!(e.length>0))throw"invalid parentElevations";if(!(t>=0))throw"invalid level";if(!(r>=0))throw"invalid row";if(!(i>=0))throw"invalid column";var a=o.getTilePositionOfParent(t,r,i),s=[],l=0;a==n.LEFT_TOP?l=0:a==n.RIGHT_TOP?l=5:a==n.LEFT_BOTTOM?l=55:a==n.RIGHT_BOTTOM&&(l=60);var h,u,c;for(h=0;h<=5;h++){for(c=l,u=0;u<=5;u++){var v=e[c];s.push(v),c++}l+=11}var f,d,p,g,m=[];for(h=0;h<=5;h++)for(u=0;u<=5;u++)c=6*h+u,f=s[c],u>0&&(g=s[c-1],p=(g+f)/2,m.push(p)),m.push(f);var T=[];for(h=0;h<=5;h++)for(u=0;u<=10;u++)c=11*h+u,f=m[c],h>0&&(d=m[c-11],p=(d+f)/2,T[11*(2*h-1)+u]=p),T[2*h*11+u]=f;return T},getLinearElevationFromParent2:function(e,t,r,i){var n=o.getTileGridAncestor(t-1,t,r,i),a=this.getLinearElevationFromParent(e,n.level,n.row,n.column),s=this.getLinearElevationFromParent(a,t,r,i);return s},getLinearElevationFromParent3:function(e,t,r,i){var n=o.getTileGridAncestor(t-1,t,r,i),a=this.getLinearElevationFromParent2(e,n.level,n.row,n.column),s=this.getLinearElevationFromParent(a,t,r,i);return s}};return a}),define("world/Image",["require","exports"],function(e,t){"use strict";var r={MAX_LEVEL:4,images:{},add:function(e,t){this.images[e]=t},get:function(e){return this.images[e]},remove:function(e){delete this.images[e]},clear:function(){this.images={}},getCount:function(){var e=0;for(var t in this.images)this.images.hasOwnProperty(t)&&e++;return e}};return r}),define("world/TileMaterial",["require","exports","world/TextureMaterial","world/Image"],function(e,t,r,i){"use strict";var n=function(e){function t(t){if(e.call(this,t),t){if(!t.image&&"string"==typeof t.url){var r=i.get(t.url);r&&(t.image=r,delete t.url)}this.level="number"==typeof t.level&&t.level>=0?t.level:20}}return __extends(t,e),t.prototype.onLoad=function(){this.level<=i.MAX_LEVEL&&i.add(this.image.src,this.image),e.prototype.onLoad.call(this)},t}(r);return n}),define("world/Tile",["require","exports","world/Kernel","world/Object3D","world/Enum","world/Elevation","world/Math","world/TileMaterial"],function(e,t,r,i,n,o,a,s){"use strict";var l=function(e){function t(t){e.call(this,null),this.level=0,this.row=0,this.column=0,this.type=n.UNKNOWN,this.elevationLevel=0,this.minLon=null,this.minLat=null,this.maxLon=null,this.maxLat=null,this.minX=null,this.minY=null,this.maxX=null,this.maxY=null,this.segment=1,this.elevationInfo=null,this.createVerticeData(t)}return __extends(t,e),t.prototype.createVerticeData=function(e){e&&(this.setTileInfo(e),this.checkTerrain())},t.prototype.setTileInfo=function(e){this.level=e.level,this.row=e.row,this.column=e.column,this.url=e.url,this.elevationLevel=o.getAncestorElevationLevel(this.level);var t=a.getTileGeographicEnvelopByGrid(this.level,this.row,this.column);this.minLon=t.minLon,this.minLat=t.minLat,this.maxLon=t.maxLon,this.maxLat=t.maxLat;var r=a.degreeGeographicToWebMercator(this.minLon,this.minLat),i=a.degreeGeographicToWebMercator(this.maxLon,this.maxLat);this.minX=r[0],this.minY=r[1],this.maxX=i[0],this.maxY=i[1];var n={level:this.level,url:this.url};this.material=new s(n)},t.prototype.checkTerrain=function(e){void 0===e&&(e=!1);var t=r.globe,i=e===!0||this.level>=r.TERRAIN_LEVEL,a=this.type!=n.TERRAIN_TILE&&i&&t&&t.camera&&90!=t.camera.pitch;if(a){this.elevationInfo||(this.elevationInfo=o.getExactElevation(this.level,this.row,this.column));var s=!!this.elevationInfo;s?this.handleTerrainTile():this.visible=!1}else this.type==n.UNKNOWN&&this.handleGlobeTile()},t.prototype.handleGlobeTile=function(){if(this.type=n.GLOBE_TILE,this.level<r.BASE_LEVEL){var e=r.BASE_LEVEL-this.level;this.segment=Math.pow(2,e)}else this.segment=1;this.handleTile()},t.prototype.handleTerrainTile=function(){this.type=n.TERRAIN_TILE,this.segment=10,this.handleTile()},t.prototype.handleTile=function(){this.visible=!0;var e,t,i=[],o=[],s=[],l=(this.maxX-this.minX)/this.segment,h=(this.maxY-this.minY)/this.segment,u=1/this.segment,c=this.type==n.TERRAIN_TILE&&this.elevationInfo,v=0,f=[],d=[],p=[],g=[];for(e=0;e<=this.segment;e++){f.push(this.minX+e*l),d.push(this.maxY-e*h);var m=e*u;p.push(m),g.push(1-m)}for(e=0;e<=this.segment;e++)for(t=0;t<=this.segment;t++){var T=f[t],y=d[e],w=c?this.elevationInfo.elevations[(this.segment+1)*e+t]:0,E=a.webMercatorToDegreeGeographic(T,y),L=a.geographicToCartesianCoord(E[0],E[1],r.EARTH_RADIUS+w+v).getArray();i=i.concat(L),s=s.concat(p[t],g[e])}for(e=0;e<this.segment;e++)for(t=0;t<this.segment;t++){var x=(this.segment+1)*e+t,M=(this.segment+1)*(e+1)+t,R=M+1,C=x+1;o=o.concat(x,M,R),o=o.concat(R,C,x)}var _={vertices:i,indices:o,textureCoords:s};this.setBuffers(_)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.subTiledLayer=null},t}(i);return l}),define("world/SubTiledLayer",["require","exports","world/Kernel","world/TileGrid","world/Object3DComponents","world/Tile","world/Elevation"],function(e,t,r,i,n,o,a){"use strict";var s=function(e){function t(t){e.call(this),this.level=-1,this.elevationLevel=-1,this.tiledLayer=null,this.level=t.level,this.elevationLevel=a.getAncestorElevationLevel(this.level)}return __extends(t,e),t.prototype.draw=function(t){this.level>=r.TERRAIN_LEVEL&&r.globe&&r.globe.camera.pitch<=r.TERRAIN_PITCH?(r.gl.clear(r.gl.DEPTH_BUFFER_BIT),r.gl.clearDepth(1),r.gl.enable(r.gl.DEPTH_TEST)):r.gl.disable(r.gl.DEPTH_TEST),e.prototype.draw.call(this,t)},t.prototype.add=function(t){t.level===this.level&&(e.prototype.add.call(this,t),t.subTiledLayer=this)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.tiledLayer=null},t.prototype.findTile=function(e,t,r){for(var i=this.children.length,n=0;n<i;n++){var o=this.children[n];if(o.level===e&&o.row===t&&o.column===r)return o}return null},t.prototype.updateTiles=function(e,t){function r(e,t,r,i){for(var n={isExist:!1,index:-1},o=0;o<e.length;o++){var a=e[o];if(a.level===t&&a.row===r&&a.column===i)return n.isExist=!0,n.index=o,n}return n}var i,n,a=[];for(i=0;i<this.children.length;i++){n=this.children[i];var s=r(e,n.level,n.row,n.column),l=s.isExist;l?e.splice(s.index,1):a.push(n)}for(;a.length>0;){var h=this.remove(a[0]);a.splice(0,1),h||console.debug("LINE:2191,subTiledLayer.remove(tilesNeedDelete[0])失败")}if(t)for(i=0;i<e.length;i++){var u=e[i],c={level:u.level,row:u.row,column:u.column,url:""};c.url=this.tiledLayer.getImageUrl(c.level,c.row,c.column),n=new o(c),this.add(n)}},t.prototype.checkTerrain=function(e){void 0===e&&(e=!1);var t=r.globe,i=e===!0||this.level>=r.TERRAIN_LEVEL;if(i&&t&&t.camera&&t.camera.pitch<r.TERRAIN_PITCH)for(var n=this.children,o=0;o<n.length;o++){var a=n[o];a.checkTerrain(e)}},t.prototype.requestElevations=function(){var e=[];if(this.level>r.ELEVATION_LEVEL){var t,n,o=this.children;for(t=0;t<o.length;t++){var s=o[t],l=i.getTileGridAncestor(this.elevationLevel,s.level,s.row,s.column);n=l.level+"_"+l.row+"_"+l.column,e.indexOf(n)<0&&e.push(n)}for(t=0;t<e.length;t++){n=e[t];var h=n.split("_"),u=parseInt(h[0]),c=parseInt(h[1]),v=parseInt(h[2]);a.elevations.hasOwnProperty(n)||a.requestElevationsByTileGrid(u,c,v)}}},t.prototype.checkIfLoaded=function(){for(var e=0;e<this.children.length;e++){var t=this.children[e];if(t){var r=t.material.loaded;if(!r)return!1}}return!0},t}(n);return s}),define("world/TiledLayer",["require","exports","world/Kernel","world/Object3DComponents","world/SubTiledLayer"],function(e,t,r,i,n){"use strict";var o=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.add=function(t){e.prototype.add.call(this,t),t.tiledLayer=this},t.prototype.wrapUrlWithProxy=function(e){return r.proxy?r.proxy+"?"+e:e},t.prototype.updateSubLayerCount=function(e){var t,r,i=this.children.length,o=e+1-i;if(o>0)for(t=0;t<o;t++){var a={level:t+i};r=new n(a),this.add(r)}else if(o<0)for(o*=-1,t=0;t<o;t++){var s=this.children.length-1;if(!(s>=2))break;r=this.children[s],this.remove(r)}},t}(i);return o}),define("world/Scene",["require","exports","world/Object3DComponents"],function(e,t,r){"use strict";var i=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t}(r);return i}),define("world/Renderer",["require","exports","world/Kernel","world/Event"],function(e,t,r,i){"use strict";var n=function(){function e(e,t,n){function o(e){try{for(var t=["webgl","experimental-webgl","webkit-3d","moz-webgl"],i=0;i<t.length;i++)if(l=e.getContext(t[i],{antialias:!0})){r.gl=l,r.canvas=e;break}}catch(e){}}function a(e,t,r){if(!r)return null;var i=null;if("VERTEX_SHADER"==t)i=e.createShader(e.VERTEX_SHADER);else{if("FRAGMENT_SHADER"!=t)return null;i=e.createShader(e.FRAGMENT_SHADER)}return e.shaderSource(i,r),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(alert(e.getShaderInfoLog(i)),console.error(e.getShaderInfoLog(i)),e.deleteShader(i),null)}function s(e,t){var i=a(r.gl,"VERTEX_SHADER",e),n=a(r.gl,"FRAGMENT_SHADER",t),o=l.createProgram();if(l.attachShader(o,i),l.attachShader(o,n),l.linkProgram(o),!l.getProgramParameter(o,l.LINK_STATUS))return console.error("Could not link program!"),l.deleteProgram(o),l.deleteShader(i),void l.deleteShader(n);l.useProgram(o),l.shaderProgram=o,l.shaderProgram.aVertexPosition=l.getAttribLocation(l.shaderProgram,"aVertexPosition"),l.shaderProgram.aTextureCoord=l.getAttribLocation(l.shaderProgram,"aTextureCoord"),l.shaderProgram.uMVMatrix=l.getUniformLocation(l.shaderProgram,"uMVMatrix"),l.shaderProgram.uPMatrix=l.getUniformLocation(l.shaderProgram,"uPMatrix"),l.shaderProgram.uSampler=l.getUniformLocation(l.shaderProgram,"uSampler"),l.shaderProgram.uOffScreen=l.getUniformLocation(l.shaderProgram,"uOffScreen"),l.uniform1i(l.shaderProgram.uOffScreen,1);var s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],h=new Float32Array(s);l.uniformMatrix4fv(l.shaderProgram.uMVMatrix,!1,h)}if(this.scene=null,this.camera=null,this.bAutoRefresh=!1,""===t)throw"invalid vertexShaderText";if(""===n)throw"invalid fragmentShaderText";r.renderer=this,i.bindEvents(e);var l;return o(e),l?(s(t,n),l.clearColor(255,255,255,1),l.disable(l.DEPTH_TEST),l.depthFunc(l.LEQUAL),l.enable(l.CULL_FACE),l.frontFace(l.CCW),void l.cullFace(l.BACK)):(alert("浏览器不支持WebGL或将WebGL禁用!"),void console.debug("浏览器不支持WebGL或将WebGL禁用!"))}return e.prototype.render=function(e,t){r.gl.viewport(0,0,r.canvas.width,r.canvas.height),r.gl.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),t.viewMatrix=null,t.viewMatrix=t.getViewMatrix(),e.draw(t)},e.prototype.bindScene=function(e){this.scene=e},e.prototype.bindCamera=function(e){this.camera=e},e.prototype.tick=function(){r.renderer instanceof e&&(r.renderer.scene&&r.renderer.camera&&r.renderer.render(r.renderer.scene,r.renderer.camera),r.renderer.bAutoRefresh&&window.requestAnimationFrame(r.renderer.tick))},e.prototype.setIfAutoRefresh=function(e){this.bAutoRefresh=e,this.bAutoRefresh&&this.tick()},e}();return n}),define("world/Globe",["require","exports","world/Kernel","world/Utils","world/ShaderContent","world/Renderer","world/PerspectiveCamera","world/Scene","world/SubTiledLayer","world/Tile","world/Image","world/Event"],function(e,t,r,i,n,o,a,s,l,h,u,c){"use strict";var v=function(){function e(e,t){this.MAX_LEVEL=15,this.CURRENT_LEVEL=-1,this.REFRESH_INTERVAL=300,this.idTimeOut=null,this.renderer=null,this.scene=null,this.camera=null,this.tiledLayer=null,t=t||{},r.globe=this;var i=n.SIMPLE_SHADER.VS_CONTENT,l=n.SIMPLE_SHADER.FS_CONTENT;this.renderer=r.renderer=new o(e,i,l),this.scene=new s;var h=e.width/e.height;this.camera=new a(30,h,1,2e7),this.renderer.bindScene(this.scene),this.renderer.bindCamera(this.camera),this.setLevel(0),this.renderer.setIfAutoRefresh(!0),c.initLayout()}return e.prototype.setTiledLayer=function(e){if(clearTimeout(this.idTimeOut),u.clear(),this.tiledLayer){var t=this.scene.remove(this.tiledLayer);t||console.error("this.scene.remove(this.tiledLayer)失败"),this.scene.tiledLayer=null}this.tiledLayer=e,this.scene.add(this.tiledLayer);var i=new l({level:0});this.tiledLayer.add(i);var n=new l({level:1});this.tiledLayer.add(n),r.canvas.style.cursor="wait";for(var o=0;o<=1;o++)for(var a=0;a<=1;a++){var s={level:1,row:o,column:a,url:""};s.url=this.tiledLayer.getImageUrl(s.level,s.row,s.column);var c=new h(s);n.add(c)}r.canvas.style.cursor="default",this.tick()},e.prototype.setLevel=function(e){if(!i.isNonNegativeInteger(e))throw"invalid level:"+e;e=e>this.MAX_LEVEL?this.MAX_LEVEL:e,e!=this.CURRENT_LEVEL&&this.camera instanceof a&&(this.camera.setLevel(e),this.refresh())},e.prototype.isAnimating=function(){return this.camera.isAnimating()},e.prototype.animateToLevel=function(e){this.isAnimating()||this.camera.animateToLevel(e)},e.prototype.tick=function(){var e=r.globe;e&&(e.refresh(),this.idTimeOut=setTimeout(e.tick,e.REFRESH_INTERVAL))},e.prototype.refresh=function(){if(this.tiledLayer&&this.scene&&this.camera){var e=this.CURRENT_LEVEL+3;this.tiledLayer.updateSubLayerCount(e);var t=this.camera.getProjViewMatrix(),n={projView:t,threshold:1};n.threshold=Math.min(90/this.camera.pitch,1.5);var o,a=this.camera.getVisibleTilesByLevel(e,n),s=[],l=a;for(o=e;o>=2;o--)s.push(l),l=i.map(l,function(e){return e.getParent()}),l=i.filterRepeatArray(l);for(s.reverse(),o=2;o<=e;o++){var h=o,u=this.tiledLayer.children[h];u.updateTiles(s[0],!0),s.splice(0,1)}r.TERRAIN_ENABLED&&this.requestElevationsAndCheckTerrain()}},e.prototype.requestElevationsAndCheckTerrain=function(){var e=this.tiledLayer.children.length-1;if(e>=r.TERRAIN_LEVEL)for(var t=r.ELEVATION_LEVEL+1;t<=e;t++){
var i=this.tiledLayer.children[t];i.requestElevations(),t>=r.TERRAIN_LEVEL&&i.checkTerrain()}},e}();return v}),define("world/Kernel",["require","exports"],function(e,t){"use strict";var r={gl:null,canvas:null,renderer:null,globe:null,idCounter:0,BASE_LEVEL:6,EARTH_RADIUS:6378137,MAX_PROJECTED_COORD:20037508.3427892,ELEVATION_LEVEL:7,TERRAIN_LEVEL:10,TERRAIN_ENABLED:!1,TERRAIN_PITCH:80,proxy:""};return r}),define("world/ArcGISTiledLayer",["require","exports","world/Kernel","world/TiledLayer"],function(e,t,r,i){"use strict";var n=function(e){function t(t){e.call(this),this.url=t}return __extends(t,e),t.prototype.getImageUrl=function(e,t,i){var n=r.proxy+"?"+this.url+"/tile/"+e+"/"+t+"/"+i;return this.wrapUrlWithProxy(n)},t}(i);return n}),define("world/AutonaviTiledLayer",["require","exports","world/TiledLayer"],function(e,t,r){"use strict";var i=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.getImageUrl=function(e,t,r){var i=e+t+r,n=1+i%4,o="//webrd0"+n+".is.autonavi.com/appmaptile?x="+r+"&y="+t+"&z="+e+"&lang=zh_cn&size=1&scale=1&style=8";return this.wrapUrlWithProxy(o)},t}(r);return i}),define("world/BingTiledLayer",["require","exports","world/Math","world/TiledLayer"],function(e,t,r,i){"use strict";var n=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.getImageUrl=function(e,t,i){var n,o="",a=i,s=t,l=r.numerationSystemFrom10(2,a),h=r.numerationSystemFrom10(2,s),u=l.length-h.length;if(u>0)for(n=0;n<u;n++)h="0"+h;else if(u<0)for(u=-u,n=0;n<u;n++)l="0"+l;var c="";for(n=0;n<h.length;n++){var v=h[n],f=l[n];c+=v+f}var d=r.numerationSystemChange(2,4,c);if(d.length<e)for(u=e-d.length,n=0;n<u;n++)d="0"+d;var p=e+t+i,g=p%8;return o="//ecn.t"+g+".tiles.virtualearth.net/tiles/h"+d+".jpeg?g=1239&mkt=en-us"},t}(i);return n}),define("world/NokiaTiledLayer",["require","exports","world/TiledLayer"],function(e,t,r){"use strict";var i=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.getImageUrl=function(e,t,r){var i=e+t+r,n=1+i%4,o="//"+n+".base.maps.api.here.com/maptile/2.1/maptile/f1f4a211b3/normal.day/"+e+"/"+r+"/"+t+"/512/png8?app_id=xWVIueSv6JL0aJ5xqTxb&app_code=djPZyynKsbTjIUDOBcHZ2g&lg=eng&ppi=72&pview=DEF";return o},t}(r);return i}),define("world/GoogleTiledLayer",["require","exports","world/TiledLayer"],function(e,t,r){"use strict";var i=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.getImageUrl=function(e,t,r){var i=e+t+r,n=1+i%3,o="//mt"+n+".google.cn/vt/lyrs=m@212000000&hl=zh-CN&gl=CN&src=app&x="+r+"&y="+t+"&z="+e+"&s=Galil";return o},t}(r);return i}),define("world/OsmTiledLayer",["require","exports","world/TiledLayer"],function(e,t,r){"use strict";var i=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.getImageUrl=function(e,t,r){var i=e+t+r,n=i%3,o=["a","b","c"][n],a="//"+o+".tile.openstreetmap.org/"+e+"/"+r+"/"+t+".png";return a},t}(r);return i}),define("world/BlendTiledLayer",["require","exports","world/TiledLayer","world/NokiaTiledLayer","world/GoogleTiledLayer","world/OsmTiledLayer"],function(e,t,r,i,n,o){"use strict";var a=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.getImageUrl=function(e,t,r){var a=[i,n,o],s=e+t+r,l=s%3,h=a[l].prototype.getImageUrl.apply(this,arguments);return h},t}(r);return a}),define("world/Ray",["require","exports"],function(e,t){"use strict";var r=function(){function e(e,t){this.vertice=e.clone(),this.vector=t.clone(),this.vector.normalize()}return e.prototype.setVertice=function(e){return this.vertice=e.clone(),this},e.prototype.setVector=function(e){return this.vector=e.clone(),this.vector.normalize(),this},e.prototype.clone=function(){var t=new e(this.vertice,this.vector);return t},e.prototype.rotateVertice=function(e){return null},e}();return r}),define("world/SosoTiledLayer",["require","exports","world/TiledLayer"],function(e,t,r){"use strict";var i=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.getImageUrl=function(e,t,r){var i="",n=Math.pow(2,e),o=r,a=n-t-1,s=Math.floor(o/16),l=Math.floor(a/16),h=e+t+r,u=h%4,c="//p"+u+".map.soso.com/sateTiles/"+e+"/"+s+"/"+l+"/"+o+"_"+a+".jpg";return i=c},t}(r);return i}),define("world/TiandituTiledLayer",["require","exports","world/TiledLayer"],function(e,t,r){"use strict";var i=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.getImageUrl=function(e,t,r){var i="",n=e+t+r,o=n%8;return i="//t"+o+".tianditu.com/DataServer?T=vec_w&x="+r+"&y="+t+"&l="+e},t}(r);return i});